<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wire Drawing</title>
    <link rel="stylesheet" href="sandboxDemo.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.min.js"></script>
</head>
<body>
    <canvas id="myCanvas" resize></canvas>
    <script type="text/paperscript" canvas="myCanvas">
        var colors={red: "#ff3657", green: "#8dff36", yellow: "#fce323", blue: "#2a46fa",
            redH: "#cc2b45", greenH: "#70cc2b", yellowH: "#ccb81d", blueH: "#2238c7",
            black: "#242424", blackHover: "#575757", whiteHover: "#f2f2f2",
            whiteAlt: "#f9f9f9", gridDot: "#000000", delete_:new Color(0.5)};
        var settings={clickFlavor:colors.whiteHover,pathFlavor:[0,0],gridSize:20,gridWidth:500,gridHeight:500,dragging:false,activeSpider:null,spiders:[],gridDots:[],highlightedDot:null,dotSizes:{original:1,enlarged:6},centerX:view.size.width/2,centerY:view.size.height/2,wireMode:false,wirePoints:[],activeWire:null,wires:[],deleteMode:false};

        var ToolBar=new Path.Rectangle({point:[settings.centerX-306,settings.centerY-46],size:[32,180],strokeColor:colors.black,strokeWidth:1,fillColor:colors.whiteAlt,radius: 16});
        var ZSpider=new Path.Circle({center:[settings.centerX-290,settings.centerY-30],radius:8,strokeColor:colors.black,strokeWidth:2,fillColor:colors.green});
        var XSpider=new Path.Circle({center:[settings.centerX-290,settings.centerY+0],radius:8,strokeColor:colors.black,strokeWidth:2,fillColor:colors.red});
        var HSpider=new Path.Rectangle({point:[settings.centerX-298,settings.centerY+22],size:[16,16],strokeColor:colors.black,strokeWidth:2,radius:2,fillColor:colors.yellow});
        var WireInit=new Path.Circle({center:[settings.centerX-290,settings.centerY+58],radius:8,strokeColor:colors.black,strokeWidth:2,fillColor:colors.whiteAlt});
        var HWireInit=new Path.Circle({center:[settings.centerX-290,settings.centerY+88],radius:8,strokeColor:colors.blue,strokeWidth:2,dashArray:[4,4],fillColor:colors.whiteAlt})
        var Bin=new Path.Rectangle({point:[settings.centerX-298,settings.centerY+108],size:[16,16],strokeColor:colors.black,strokeWidth:2,radius:2,fillColor:colors.delete_});
        
        var inregion = true;
        createGrid();

        function createGrid(){
            settings.gridDots=[];
            for(var x=settings.centerX-settings.gridWidth/2;x<settings.centerX+settings.gridWidth/2;x+=settings.gridSize)
                for(var y=settings.centerY-settings.gridHeight/2;y<settings.centerY+settings.gridHeight/2;y+=settings.gridSize){
                    var dot=new Path.Circle({center:[x+10,y+10],radius:settings.dotSizes.original,fillColor:colors.gridDot});
                    settings.gridDots.push(dot);
                }
        }

                function onResize(event){
            settings.centerX=view.size.width/2;
            settings.centerY=view.size.height/2;
            //createGrid();
            updateWires();
        }

        function isPointInGridBounds(point) {
    var gridLeft = settings.centerX - settings.gridWidth / 2;
    var gridRight = settings.centerX + settings.gridWidth / 2;
    var gridTop = settings.centerY - settings.gridHeight / 2;
    var gridBottom = settings.centerY + settings.gridHeight / 2;
    
    return point.x >= gridLeft && point.x <= gridRight && point.y >= gridTop && point.y <= gridBottom;
}

        function snapToGrid(point){
            return new Point(
                Math.round((point.x-settings.centerX)/settings.gridSize)*settings.gridSize+settings.centerX,
                Math.round((point.y-settings.centerY)/settings.gridSize)*settings.gridSize+settings.centerY
            );
        }

        function onClick(event){
            inregion = isPointInGridBounds(event.point);
    if (ZSpider.contains(event.point)) {
        document.getElementById('myCanvas').style.cursor = 'crosshair';
        settings.clickFlavor = colors.green;
        highlightSelection();
        settings.wireMode = false; settings.deleteMode = false;
        return;
    }
    if (XSpider.contains(event.point)) {
        document.getElementById('myCanvas').style.cursor = 'crosshair';
        settings.clickFlavor = colors.red;
        highlightSelection();
        settings.wireMode = false; settings.deleteMode = false;
        return;
    }
    if (HSpider.contains(event.point)) {
        document.getElementById('myCanvas').style.cursor = 'crosshair';
        settings.clickFlavor = colors.yellow;
        highlightSelection();
        settings.wireMode = false; settings.deleteMode = false;
        return;
    }
    if (WireInit.contains(event.point)) {
        document.getElementById('myCanvas').style.cursor = 'crosshair';
        settings.clickFlavor = colors.gridDot;
        settings.wireMode = true; settings.deleteMode = false;
        highlightSelection();
        return;
    }
    if (HWireInit.contains(event.point)) {
        document.getElementById('myCanvas').style.cursor = 'crosshair';
        settings.clickFlavor = colors.blue;
        settings.wireMode = true; settings.deleteMode = false;
        highlightSelection();
        return;
    }
    if (Bin.contains(event.point)) {
        document.getElementById('myCanvas').style.cursor = 'crosshair';
        settings.clickFlavor = colors.delete_;
        highlightSelection(); // when bin is clicked does it change?
        settings.wireMode = false; settings.deleteMode = true;
        return;
    }
    if (inregion) {
        if (!settings.deleteMode) {
            if (settings.wireMode) {
                document.getElementById('myCanvas').style.cursor = 'crosshair';
                var snappedPoint = snapToGrid(event.point);
                if (!getSpiderAt(snappedPoint)) createBlackSpiderAt(snappedPoint); // if line is not being drawn ontop of another spider
                handleWireClick(event);
                return;
            }
            if (settings.dragging && settings.activeSpider) { // stop the spider dragging
                if (settings.clickFlavor !== colors.whiteHover){
                document.getElementById('myCanvas').style.cursor = 'crosshair';
                }
                settings.activeSpider.position = snapToGrid(event.point);
                settings.dragging = false;
                settings.activeSpider.strokeWidth = 2;
                settings.activeSpider.strokeColor = colors.black;
                settings.activeSpider = null;
                updateWires();
                return;
            }
            for (var i = 0; i < settings.spiders.length; i++) { // finding a spider to drag
                if (settings.spiders[i].contains(event.point)) {
                    document.getElementById('myCanvas').style.cursor = 'default';
                    settings.activeSpider = settings.spiders[i];
                    settings.dragging = true;
                    settings.activeSpider.strokeWidth = 3;
                    settings.activeSpider.strokeColor = settings.activeSpider.fillColor;
                    return;
                }
            }
            var newSpiderPosition = snapToGrid(event.point);
            if (!getSpiderAt(newSpiderPosition)&&settings.clickFlavor!==colors.whiteHover) {
                if (settings.clickFlavor!==colors.yellow){
                var newSpider = new Path.Circle({
                    center: newSpiderPosition,
                    radius: 8,
                    strokeColor: colors.black,
                    strokeWidth: 2,
                    fillColor: settings.clickFlavor
                });
            }
            else{ // if hadamard init has been clicked
                var newSpider = new Path.Rectangle({
                    point: newSpiderPosition-[8,8],
                    size:[16,16],
                    strokeColor: colors.black,
                    strokeWidth: 2,
                    radius: 2,
                    fillColor: settings.clickFlavor
                });
            }
                settings.spiders.push(newSpider);
                newSpider.bringToFront(); // Ensure the new spider is brought to the front
            }
        }
    else if (settings.deleteMode) { // deleting
        var hitResult = project.hitTest(event.point);
        if (hitResult) {
            var clickedItem = hitResult.item;
            //spiders
            var spiderIndex = settings.spiders.findIndex(function(spider) {
                return spider === clickedItem;
            });
            if (spiderIndex > -1) {
                // search for connections to this spider
                var legsArray = [];
                for (var i = 0; i < settings.wires.length; i++) {
                    for (var j = 0; j < 2; j++) {
                        if (settings.wires[i].ends[j].position.x===settings.spiders[spiderIndex].position.x && settings.wires[i].ends[j].position.y===settings.spiders[spiderIndex].position.y) {
                            legsArray.push(settings.wires[i].path);
                        }
                    }
                }
                for (var i=0; i < legsArray.length; i++) { // removing all legs
                    delAllofWire(legsArray[i]);
                }
                if (legsArray.length===0||settings.spiders[spiderIndex].bounds.width!==6) {
                    settings.spiders[spiderIndex].remove(); // remove lone clicked spider or coloured joined spider
                    settings.spiders.splice(spiderIndex, 1);
                }
                return;
            }
            //wires and any lone black nodes
            delAllofWire(clickedItem);
            return;
        }
    }
    }else{
        settings.clickFlavor = colors.whiteHover;
        document.getElementById('myCanvas').style.cursor = 'default';
        settings.wireMode = false; settings.deleteMode = false;
        highlightSelection();
        return;
    }
    
}
        
function delAllofWire(clickedItem){
    var wireIndex = settings.wires.findIndex(function(wire) {
        return wire.path === clickedItem;
    });
    if (wireIndex > -1) {
        var endspi = settings.wires[wireIndex].ends;
        for (var i = 0; i < 2; i++) {
            var endspiConnected = 0;
            var spiderIndex = settings.spiders.findIndex(function(spider) {
                return spider === endspi[i];
            });

            for (var j = 0; j < settings.wires.length; j++) { // searching to find if end node is connected to any more strings
                for (var k = 0; k < 2; k++) {
                    if (endspi[i]===settings.wires[j].ends[k]) {
                        endspiConnected += 1
                    }
                }
            }
            if (endspi[i].bounds.width===6 && endspiConnected<2) {  // if end of cable has simple node and it is not connected to another cable
                settings.spiders[spiderIndex].remove();
                settings.spiders.splice(spiderIndex, 1);
            }
        }
        settings.wires[wireIndex].path.remove();
        settings.wires.splice(wireIndex, 1);
    }
}

function createBlackSpiderAt(point){
    var blackSpider=new Path.Circle({center:point,radius:3,strokeColor:colors.black,strokeWidth:2,fillColor:colors.black});
    settings.spiders.push(blackSpider);
    blackSpider.bringToFront(); // Ensure the new spider is brought to the front
}


        function handleWireClick(event){
            var snappedPoint=snapToGrid(event.point);
            settings.wirePoints.push(snappedPoint); // settings.wirePoints keeps track of cable curreltly being drawn
            if(settings.wirePoints.length===2){
                if (settings.clickFlavor===colors.gridDot){
                var wire=new Path.Line({from:settings.wirePoints[0],to:settings.wirePoints[1],strokeColor:settings.clickFlavor,strokeWidth:2});
                }else{
                var wire=new Path.Line({from:settings.wirePoints[0],to:settings.wirePoints[1],strokeColor:settings.clickFlavor,strokeWidth:2,dashArray:[4,4]});
                }
                settings.wires.push({path:wire,ends:[getSpiderAt(settings.wirePoints[0]),getSpiderAt(settings.wirePoints[1])]});
                settings.wirePoints=[];
                if(settings.activeWire){
                    settings.activeWire.remove();
                    settings.activeWire=null;
                }
                wire.sendToBack();
            }
        }

        function getSpiderAt(point){
            for(var i=0;i<settings.spiders.length;i++)
                if(settings.spiders[i].bounds.contains(point)) return settings.spiders[i];
            return null;
        }

        function updateWires(){
            for(var i=0;i<settings.wires.length;i++){
                var wire=settings.wires[i];
                var spiderA=wire.ends[0];
                var spiderB=wire.ends[1];
                if(spiderA&&spiderB){
                    wire.path.segments[0].point=spiderA.position;
                    wire.path.segments[1].point=spiderB.position;
                }else{
                    var startPoint=wire.path.segments[0].point;
                    var endPoint=wire.path.segments[1].point;
                    var nearestStart=findNearestSpiderOrBlackDot(startPoint);
                    var nearestEnd=findNearestSpiderOrBlackDot(endPoint);
                    if(nearestStart){
                        wire.path.segments[0].point=nearestStart.position;
                        wire.ends[0]=nearestStart;
                    }
                    if(nearestEnd){
                        wire.path.segments[1].point=nearestEnd.position;
                        wire.ends[1]=nearestEnd;
                    }
                }
            }
        }

        function findNearestSpiderOrBlackDot(point){
            var nearest=null,minDist=Infinity;
            settings.spiders.forEach(function(spider){
                var dist=point.getDistance(spider.position);
                if(dist<minDist){
                    minDist=dist;
                    nearest=spider;
                }
            });
            settings.spiders.forEach(function(dot){
                if(dot.fillColor===colors.black){
                    var dist=point.getDistance(dot.position);
                    if(dist<minDist){
                        minDist=dist;
                        nearest=dot;
                    }
                }
            });
            return minDist<10?nearest:null;
        }

        function onMouseMove(event){
            if(settings.dragging&&settings.activeSpider){
                highlightNearestDot(event.point);
                settings.activeSpider.position=snapToGrid(event.point);
                updateWires();
            }
            if (settings.deleteMode) {
                
            }else{
                highlightNearestDot(event.point);
                if(settings.wireMode&&settings.wirePoints.length===1){ // temporary smaller wire whilst drawing
                    if(settings.activeWire) settings.activeWire.remove();
                    settings.activeWire=new Path.Line({
                        from:settings.wirePoints[0],
                        to:snapToGrid(event.point),
                        strokeColor:colors.black,
                        strokeWidth:1,
                        dashArray:[2,2]
                    });
                }
            }
        }

        function highlightSelection(){
            if(settings.clickFlavor===colors.green){
                ZSpider.strokeColor=colors.greenH;
                ZSpider.strokeWidth=3;
            }else{
                ZSpider.strokeColor=colors.black;
                ZSpider.strokeWidth=2;
            }
            if(settings.clickFlavor===colors.red){
                XSpider.strokeColor=colors.redH;
                XSpider.strokeWidth=3;
            }else{
                XSpider.strokeColor=colors.black;
                XSpider.strokeWidth=2;
            }
            if(settings.clickFlavor===colors.yellow){
                HSpider.strokeColor=colors.yellowH;
                HSpider.strokeWidth=3;
            }else{
                HSpider.strokeColor=colors.black;
                HSpider.strokeWidth=2;
            }
            if(settings.clickFlavor===colors.gridDot){
                WireInit.strokeColor=colors.blackHover;
                WireInit.strokeWidth=3;
            }else{
                WireInit.strokeColor=colors.black;
                WireInit.strokeWidth=2;
            }
            if(settings.clickFlavor===colors.blue){
                HWireInit.strokeColor=colors.blueH;
                HWireInit.strokeWidth=3;
            }else{
                HWireInit.strokeColor=colors.blue;
                HWireInit.strokeWidth=2;
            }
        }

        function highlightNearestDot(point){
    var nearestDot = null, minDist = Infinity;
    settings.gridDots.forEach(function(dot){
        var dist = point.getDistance(dot.position);
        if (dist < minDist && !getSpiderAt(dot.position)) {
            minDist = dist;
            nearestDot = dot;
        }
    });
    if (nearestDot && minDist < settings.gridSize / 2) {
        if (settings.highlightedDot) {
            settings.highlightedDot.scale(settings.dotSizes.original / settings.dotSizes.enlarged);
            settings.highlightedDot.fillColor = colors.gridDot;
        }
        nearestDot.scale(settings.dotSizes.enlarged / settings.dotSizes.original);
        nearestDot.fillColor = settings.clickFlavor;
        settings.highlightedDot = nearestDot;

    } else if (settings.highlightedDot) {
        settings.highlightedDot.scale(settings.dotSizes.original / settings.dotSizes.enlarged);
        settings.highlightedDot.fillColor = colors.gridDot;
        settings.highlightedDot = null;
    }
}
        view.on('mousedown',onClick);
        view.on('mousemove',onMouseMove);
        view.on('resize',onResize);
        highlightSelection();
    </script>
</body>
</html>
